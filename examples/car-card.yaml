# Prizrak Monitoring - Car Control Card
# Based on monitoring.tecel.ru control panel design
# Replace 95311 with your device ID

type: custom:button-card
template: custom_card_prizrak_main
variables:
  device_id: "95311"

---

# Alternative: Vertical Stack with all components
type: vertical-stack
cards:
  # Main car visualization with SVG
  - type: custom:button-card
    entity: binary_sensor.prizrak_95311_guard
    name: " "
    show_state: false
    show_icon: false
    styles:
      card:
        - background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%)
        - border-radius: 15px
        - padding: 20px
        - box-shadow: 0 4px 8px rgba(0,0,0,0.3)
      grid:
        - grid-template-areas: '"status" "car" "info" "buttons"'
        - grid-template-rows: auto 1fr auto auto
        - grid-gap: 15px
    custom_fields:
      # Top status bar with balance and icons
      status: |
        [[[
          const balance = states['sensor.prizrak_95311_sim_balance'];
          const sensors_active = states['binary_sensor.prizrak_95311_gps'].state === 'on';
          const park_brake = states['binary_sensor.prizrak_95311_parking_brake'].state === 'on';

          return `
            <div style="display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px;">
              <div style="background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 5px;">
                ${balance ? balance.state + '₽' : '-'}
              </div>
              <div style="display: flex; gap: 10px;">
                ${sensors_active ? '<ha-icon icon="mdi:radar" style="color: #00c0fc;"></ha-icon>' : ''}
                ${park_brake ? '<ha-icon icon="mdi:car-brake-parking" style="color: #ff9800;"></ha-icon>' : ''}
              </div>
            </div>
          `;
        ]]]

      # SVG Car visualization
      car: |
        [[[
          const guard = states['binary_sensor.prizrak_95311_guard'].state === 'on';
          const ignition = states['binary_sensor.prizrak_95311_ignition'].state === 'on';
          const hood = states['binary_sensor.prizrak_95311_hood'].state === 'on';
          const trunk = states['binary_sensor.prizrak_95311_trunk'].state === 'on';
          const door_fl = states['binary_sensor.prizrak_95311_driver_door'].state === 'on';
          const door_fr = states['binary_sensor.prizrak_95311_front_pass_door'].state === 'on';
          const door_rl = states['binary_sensor.prizrak_95311_rear_left_door'].state === 'on';
          const door_rr = states['binary_sensor.prizrak_95311_rear_right_door'].state === 'on';

          // Colors
          const guardColor = guard ? '#00c0fc' : '#4a5c74';
          const doorOpenColor = '#ff9800';
          const lightsColor = ignition ? '#ffeb3b' : 'transparent';
          const bodyStroke = ignition ? '#ffffff' : (guard ? guardColor : '#4a5c74');
          const bodyStrokeWidth = ignition ? '3' : (guard ? '2' : '1');

          return `
            <svg viewBox="0 0 120 180" style="width: 100%; max-width: 250px; margin: 0 auto; display: block;">
              <!-- Outer perimeter (guard glow) -->
              <path d="M64.3,178.6h-8.5c-14.6,0-25.4-4.8-32.3-14.1c-4.7-6.5-7.1-14.8-7.1-24.8v-100c0-3.2,0.3-6.3,1-9.4
              C20.4,16.4,30,6.4,43.8,2.9c4.1-1,8.4-1.5,12.6-1.5h7.2c4.2,0,8.5,0.5,12.6,1.5C90,6.4,99.6,16.4,102.6,30.2c0.7,3.1,1,6.2,1,9.4
              v100c0,10-2.4,18.4-7.1,24.8C89.7,173.8,78.8,178.6,64.3,178.6z"
              fill="none" stroke="${bodyStroke}" stroke-width="${bodyStrokeWidth}" opacity="${guard || ignition ? '0.8' : '0.3'}"/>

              <!-- Car body -->
              <path d="M92.3,114.8l-1.2-1.1v-10.6v-1.4V77.9L91,67.7v-2.1l1.2-1.1c0.5-0.4,0.8-1,0.8-1.7V41c0-0.6-0.3-1.3-0.9-1.7l-0.8-0.7
              c-0.3-0.1-0.4-0.4-0.4-0.7c-0.1-1.6-0.3-3.2-0.6-4.7c-1.4-6.5-5.6-14.8-17.3-17.8c-3.1-0.8-6.3-1.1-9.5-1.1h-3.4h-0.2h-3.4
              c-3.2,0-6.4,0.3-9.5,1.1c-11.7,3-15.9,11.3-17.3,17.8c-0.3,1.5-0.5,3.1-0.6,4.7c0,0.3-0.1,0.6-0.4,0.7l-0.8,0.7
              C27.3,39.7,27,40.4,27,41v21.8c0,0.7,0.3,1.3,0.8,1.7l1.2,1.1v2.1l-0.1,10.2v23.8v1.4v10.6l-1.2,1.1c-0.5,0.4-0.8,1.1-0.8,1.7V140
              c0,0.7,0.3,1.3,0.8,1.7l0.9,0.8c0.2,0.2,0.3,0.4,0.4,0.7c1.3,14.8,10.2,22.4,26.7,22.4h4.2h0.2h4.2c16.5,0,25.4-7.6,26.7-22.4
              c0.1-0.3,0.2-0.5,0.4-0.7l0.9-0.8c0.5-0.4,0.8-1,0.8-1.7v-23.5C93.1,115.9,92.8,115.2,92.3,114.8z"
              fill="#34495e" stroke="#2c3e50" stroke-width="0.5"/>

              <!-- Hood (open state) -->
              ${hood ? `<path d="M84.4,65.2c-0.4,0-0.6-0.2-0.8-0.4c-0.8-1.3-5.6-7.4-23.7-7.4S37,63.5,36.2,64.8c-0.2,0.3-0.4,0.4-0.7,0.4
              s-0.6-0.1-0.8-0.3l-1.1-1.3c-0.4-0.4-0.6-1-0.6-1.5V40.8c0-2.2,0.2-4.4,0.6-6.5c0.3-1.7,0.8-3.3,1.4-4.9
              c3.3-2.8,6.3-6.1,8.7-9.7c2.1-1.7,8.8-2.8,12.4-2.8h6.7c3.6,0,10.3,1.1,12.4,2.8c2.4,3.6,5.4,6.9,8.7,9.7
              c0.6,1.6,1.1,3.2,1.5,4.9c0.4,2.1,0.6,4.3,0.6,6.5V62c0,0.6-0.2,1.1-0.6,1.5l-1.1,1.3C85,65.1,84.7,65.2,84.4,65.2z"
              fill="${doorOpenColor}" opacity="0.7"/>` : ''}

              <!-- Trunk (open state) -->
              ${trunk ? `<path d="M63.9,161.1H56c-12.2,0-17.7-5.2-19.1-6.7v-13.5c0-0.5,0.4-1,0.9-1c0.2,0,0.3,0,0.5,0.1c1.6,1,7.9,4.2,21.8,4.2
              s20.2-3.2,21.8-4.2c0.4-0.3,1-0.1,1.3,0.3c0.1,0.2,0.1,0.3,0.1,0.5v13.5C80.2,157.6,73.6,161.1,63.9,161.1z"
              fill="${doorOpenColor}" opacity="0.7"/>` : ''}

              <!-- Door Front Left -->
              ${door_fl ? `<path d="M41.2,103v-3.1c0-11.5-2.5-21.8-4.2-25.9c-0.9-2.2-1.7-3.8-2.7-5c-0.7-0.9-1.5-1.7-2.3-2.5l-3-2.4v4.6
              c-2.7,0.7-4.9,2.5-6.3,5c-0.3,0.6-0.3,1.3,0.1,1.8c0.3,0.4,0.8,0.6,1.2,0.6c0.1,0,0.3,0,0.4-0.1l4.9-1.3v28.3H41.2z"
              fill="${doorOpenColor}" opacity="0.7"/>` : ''}

              <!-- Door Front Right -->
              ${door_fr ? `<path d="M97.8,73.7c-1.4-2.5-3.7-4.2-6.3-5V64l-3,2.4c-0.5,0.4-1,0.9-1.4,1.3c-0.3,0.4-0.6,0.7-0.9,1.1
              c-1,1.3-1.8,2.9-2.7,5c-1.7,4.1-4.2,14.5-4.2,25.9v3.1h12.3V74.7l4.9,1.4c0.1,0,0.3,0.1,0.4,0.1c0.5,0,0.9-0.2,1.2-0.6
              C98,75,98.1,74.2,97.8,73.7z" fill="${doorOpenColor}" opacity="0.7"/>` : ''}

              <!-- Door Rear Left -->
              ${door_rl ? `<path d="M28.9,101.7v28.8c0,1.4,1.1,2.6,2.6,2.6h2.2c1.9,0,2.9-0.8,3.7-2.6c1.3-3.1,3.8-14.7,3.8-25.9v-3L28.9,101.7z"
              fill="${doorOpenColor}" opacity="0.7"/>` : ''}

              <!-- Door Rear Right -->
              ${door_rr ? `<path d="M78.8,101.7v3c0,11.1,2.4,22.8,3.8,25.9c0.8,1.8,1.8,2.6,3.7,2.6h2.2c1.4,0,2.6-1.2,2.6-2.6v-28.8L78.8,101.7z"
              fill="${doorOpenColor}" opacity="0.7"/>` : ''}

              <!-- Headlights (when ignition on) -->
              ${ignition ? `
                <path d="M29.8,33.8c1.4-6.4,5.5-14.6,17-17.5c-8.1,13.7-16.6,17.3-17,17.4L29.8,33.8z" fill="${lightsColor}" opacity="0.9"/>
                <path d="M90.2,33.8c-0.4-0.1-8.9-3.8-17-17.4c11.6,3,15.7,11.2,17,17.5L90.2,33.8z" fill="${lightsColor}" opacity="0.9"/>
              ` : ''}

              <!-- Stop lights (when ignition on) -->
              ${ignition ? `
                <path d="M72.1,163.1c-0.7,0-1.2-0.6-1.2-1.3v-2.3c6.8-1.4,10.1-4.5,11.2-5.7v1c0,2.5-1.3,4.8-3.4,6.1
                c-2.2,1.4-4.7,2.3-7.2,2.8C72.2,163.1,72.2,163.1,72.1,163.1z" fill="#ff0000" opacity="0.9"/>
                <path d="M47.9,163.1c-0.1,0-0.2,0-0.2,0c-2.5-0.5-5-1.5-7.2-2.8c-2.1-1.3-3.4-3.6-3.4-6.1v-1c1.1,1.3,4.4,4.3,11.3,5.7
                v2.3c0,0.4-0.2,0.7-0.5,1C48.5,163,48.2,163.1,47.9,163.1z" fill="#ff0000" opacity="0.9"/>
              ` : ''}
            </svg>
          `;
        ]]]

      # Temperature and telemetry info
      info: |
        [[[
          const tempOutside = states['sensor.prizrak_95311_outside_temperature'];
          const tempEngine = states['sensor.prizrak_95311_engine_temperature'];
          const tempCabin = states['sensor.prizrak_95311_temperature'];
          const voltage = states['sensor.prizrak_95311_battery_voltage'];
          const rpm = states['sensor.prizrak_95311_rpm'];
          const fuel = states['sensor.prizrak_95311_fuel_level'];
          const speed = states['sensor.prizrak_95311_speed'];
          const odometer = states['sensor.prizrak_95311_odometer'];
          const guardState = states['binary_sensor.prizrak_95311_guard'];
          const alarmState = states['sensor.prizrak_95311_alarm'];

          const blockStyle = 'background: rgba(255,255,255,0.05); border-radius: 8px; padding: 8px; text-align: center;';
          const titleStyle = 'font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 4px;';
          const valueStyle = 'font-size: 16px; font-weight: bold; color: white;';

          return `
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; color: white;">
              <!-- Row 1: Temperatures -->
              <div style="${blockStyle}">
                <div style="${titleStyle}">На улице</div>
                <div style="${valueStyle}">${tempOutside && tempOutside.state !== 'unavailable' ? tempOutside.state + '°C' : '-'}</div>
              </div>
              <div style="${blockStyle}">
                <div style="${titleStyle}">Двигатель</div>
                <div style="${valueStyle}">${tempEngine && tempEngine.state !== 'unavailable' ? tempEngine.state + '°C' : '-'}</div>
              </div>
              <div style="${blockStyle}">
                <div style="${titleStyle}">В салоне</div>
                <div style="${valueStyle}">${tempCabin && tempCabin.state !== 'unavailable' ? tempCabin.state + '°C' : '-'}</div>
              </div>

              <!-- Row 2: Voltage, RPM, Guard -->
              <div style="${blockStyle}">
                <div style="${titleStyle}">Напряжение</div>
                <div style="${valueStyle}">${voltage ? voltage.state + 'В' : '-'}</div>
              </div>
              <div style="${blockStyle}">
                <div style="${titleStyle}">Обороты</div>
                <div style="${valueStyle}">${rpm ? rpm.state : '0'}</div>
              </div>
              <div style="${blockStyle}">
                <div style="${titleStyle}">Охрана</div>
                <div style="${valueStyle}; color: ${guardState.state === 'on' ? '#00c0fc' : '#ff9800'};">
                  ${guardState.state === 'on' ? 'В охране' : 'Снята'}
                </div>
              </div>

              <!-- Row 3: Fuel, Speed, Odometer -->
              <div style="${blockStyle}">
                <div style="${titleStyle}">Топливо</div>
                <div style="${valueStyle}">${fuel ? fuel.state + 'л' : '-'}</div>
              </div>
              <div style="${blockStyle}">
                <div style="${titleStyle}">Скорость</div>
                <div style="${valueStyle}">${speed ? speed.state + ' км/ч' : '0 км/ч'}</div>
              </div>
              <div style="${blockStyle}">
                <div style="${titleStyle}">Пробег</div>
                <div style="${valueStyle}">${odometer ? odometer.state + ' км' : '-'}</div>
              </div>
            </div>
          `;
        ]]]

      # Control buttons
      buttons: |
        [[[
          const guardState = states['binary_sensor.prizrak_95311_guard'].state;
          const ignitionState = states['binary_sensor.prizrak_95311_ignition'].state;

          const buttonStyle = 'flex: 1; padding: 15px; border-radius: 10px; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 12px; transition: all 0.3s;';
          const guardActive = guardState === 'on';
          const ignitionActive = ignitionState === 'on';

          return `
            <div style="display: flex; gap: 10px;">
              <button onclick="this.dispatchEvent(new CustomEvent('hass-more-info', {bubbles:true, composed:true, detail:{entityId:'button.prizrak_95311_guard_${guardActive ? 'off' : 'on'}'}}));"
                style="${buttonStyle} background: ${guardActive ? '#00c0fc' : 'rgba(255,255,255,0.1)'}; color: white;">
                <ha-icon icon="mdi:shield-${guardActive ? 'check' : 'off'}" style="--mdc-icon-size: 32px;"></ha-icon>
                <span>${guardActive ? 'Охрана Вкл' : 'Охрана Выкл'}</span>
              </button>

              <button onclick="this.dispatchEvent(new CustomEvent('hass-more-info', {bubbles:true, composed:true, detail:{entityId:'button.prizrak_95311_autolaunch_${ignitionActive ? 'off' : 'on'}'}}));"
                style="${buttonStyle} background: ${ignitionActive ? '#ff9800' : 'rgba(255,255,255,0.1)'}; color: white;">
                <ha-icon icon="mdi:engine${ignitionActive ? '' : '-off'}" style="--mdc-icon-size: 32px;"></ha-icon>
                <span>${ignitionActive ? 'Заглушить' : 'Автозапуск'}</span>
              </button>

              <button onclick="this.dispatchEvent(new CustomEvent('hass-more-info', {bubbles:true, composed:true, detail:{entityId:'binary_sensor.prizrak_95311_connection'}}));"
                style="${buttonStyle} background: rgba(255,255,255,0.1); color: white;">
                <ha-icon icon="mdi:dots-horizontal" style="--mdc-icon-size: 32px;"></ha-icon>
                <span>Команды</span>
              </button>
            </div>
          `;
        ]]]
